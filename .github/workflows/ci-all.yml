name: CI/CD Project Pipeline (All Code Run)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          # โฟลเดอร์ที่ถูกต้องสำหรับรันคำสั่ง (อ้างอิงจากโครงสร้าง repo)
          cd 01-beginner/project-02-ci-pipeline-demo/backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          cd 01-beginner/project-02-ci-pipeline-demo/backend
          pytest --cov=.

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: 01-beginner/project-02-ci-pipeline-demo/frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd 01-beginner/project-02-ci-pipeline-demo/frontend
          npm ci

      - name: Run tests
        run: |
          cd 01-beginner/project-02-ci-pipeline-demo/frontend
          npm test

  build:
    name: Build Docker Images and Push to Registry
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Login to Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push backend image
        run: |
          COMMIT_SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          DOCKER_IMAGE_NAME="project1-backend"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          IMAGE_TAG="${DOCKER_USER}/${DOCKER_IMAGE_NAME}:${COMMIT_SHA_SHORT}"

          echo "Building Backend Image: ${IMAGE_TAG}"
          # แก้ไข Path ให้ถูกต้องตามโครงสร้าง repo
          cd 01-beginner/project-02-ci-pipeline-demo/backend
          docker build -t ${IMAGE_TAG} .
          docker push ${IMAGE_TAG}

      - name: Build and Push frontend image
        run: |
          COMMIT_SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          DOCKER_IMAGE_NAME="project1-frontend"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          IMAGE_TAG="${DOCKER_USER}/${DOCKER_IMAGE_NAME}:${COMMIT_SHA_SHORT}"

          echo "Building Frontend Image: ${IMAGE_TAG}"
          # แก้ไข Path ให้ถูกต้องตามโครงสร้าง repo
          cd 01-beginner/project-02-ci-pipeline-demo/frontend
          docker build -t ${IMAGE_TAG} .
          docker push ${IMAGE_TAG}
